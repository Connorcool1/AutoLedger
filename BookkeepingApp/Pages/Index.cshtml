@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="mb-4 text-center">File Upload</h1>
            
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                <div id="dropZone" class="drop-zone p-5 border-3 border-dashed rounded text-center position-relative" style="min-height: 300px; background-color: #f8f9fa; border-color: #dee2e6; cursor: pointer; transition: all 0.3s ease;">
                    <input type="file" name="file" id="fileInput" class="d-none" required />
                    
                    <div class="drop-zone-content">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mx-auto mb-3 text-primary">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <h3 class="mb-2">Drag and drop your file here</h3>
                        <p class="text-muted mb-3">or click to select a file</p>
                        <small class="text-secondary">Supports all file formats</small>
                    </div>
                </div>
                
                <div class="mt-4 text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <span class="spinner-border spinner-border-sm me-2 d-none" id="spinner" role="status" aria-hidden="true"></span>
                        Upload File
                    </button>
                </div>
            </form>
            
            @if (Model.Message != null)
            {
                <div class="alert alert-info alert-dismissible fade show mt-4" role="alert">
                    @Model.Message
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            
            @if (Model.ParsedItems != null && Model.ParsedItems.Count > 0)
            {
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">Parsed Transactions (@Model.ParsedItems.Count)</h4>
                        <button type="button" class="btn btn-success btn-lg" id = "downloadBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 8px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Review & Download
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th></th>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <form id="selectionForm">
                                    @for(int i = 0; i < Model.ParsedItems.Count; i++)
                                    {
                                        var item = Model.ParsedItems[i];
                                        <tr>
                                            <td><input class ="form-check-input item-checkbox" type="checkbox" name ="selectedItems" value="@i" id="item_@i" checked /></td>
                                            <td>@item.Date.ToString("dd/MM/yyyy")</td>
                                            <td>@item.Description</td>
                                            <td>£@item.Amount.ToString("F2")</td>
                                        </tr>
                                    }
                                </form>
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    </div>
</div>



<style>
    .drop-zone {
        border: 3px dashed #dee2e6;
        transition: all 0.3s ease;
    }
    
    .drop-zone.drag-over {
        background-color: #e7f1ff !important;
        border-color: #0d6efd !important;
        box-shadow: 0 0 15px rgba(13, 110, 253, 0.2);
    }
    
    .drop-zone-content {
        pointer-events: none;
    }

    .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }

    .form-check-input:checked:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
    }
</style>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');
    const spinner = document.getElementById('spinner');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const selectionForm = document.getElementById('selectionForm');
    const checkboxes = document.querySelectorAll('.item-checkbox');

    // Click to upload
    dropZone.addEventListener('click', () => fileInput.click());

    // Drag and drop events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            uploadForm.submit();
        }
    });

    // File input change event
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            dropZone.querySelector('.drop-zone-content').innerHTML = 
                `<p class="mb-0"><strong>${e.target.files[0].name}</strong></p><small class="text-success">Ready to upload</small>`;
        }
    });

    // Show spinner on submit
    uploadForm.addEventListener('submit', () => {
        spinner.classList.remove('d-none');
    });


    // Download functionality
    downloadBtn.addEventListener('click', async () => {
        const selectedIndices = Array.from(checkboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);

        if (selectedIndices.length === 0) {
            alert('Please select at least one transaction to download.');
            return;
        }

        // Create hidden form to submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '@Url.Page("Index", "Download")';

        selectedIndices.forEach(index => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selectedIndices';
            input.value = index;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    });
</script>
