@page
@model TypeAssignModel
@{
    ViewData["Title"] = "Home page";
}

<div class="container mt-5">
    <div class="row mt-4">     
        <h1>Assign Transaction Types: </h1>
        @if (Model.Message != null)
        {
            <div class="alert alert-info alert-dismissible fade show mt-4" role="alert">
                @Model.Message
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
        
        @if (Model.FilteredItems != null && Model.FilteredItems.Count > 0)
        {
            <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button type="submit" form="downloadForm" class="btn btn-success btn-lg" id="downloadBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 8px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download
                    </button>
                </div>
                <div class="d-flex align-items-start gap-4">
                    <div class="table-responsive">
                        <form method="post" asp-page-handler="Download" id="downloadForm">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th class="pe-5 amount-col">Amount</th>
                                        <th class="type-header">Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                        @for(int i = 0; i < Model.FilteredItems.Count; i++)
                                        {
                                            var item = Model.FilteredItems[i];
                                            <tr>
                                                <td>@item.Date.ToString("dd/MM/yyyy")</td>
                                                <td>@item.Description</td>
                                                <td class="pe-5 amount-col">Â£@item.Amount.ToString("F2")</td>
                                                <td class="type-cell text-center align-middle">
                                                    <div class="d-flex gap-2 justify-content-center align-items-middle">
                                                        <input type="radio" class="type-radio" 
                                                            name="ItemTypes[@item.Id]" 
                                                            value="Ingredients" id="t1_@item.Id" hidden>
                                                        <label for="t1_@item.Id" class="type-box bg-success"></label>

                                                        <input type="radio" class="type-radio" 
                                                            name="ItemTypes[@item.Id]" 
                                                            value="Packaging" id="t2_@item.Id" hidden>
                                                        <label for="t2_@item.Id" class="type-box bg-primary"></label>

                                                        <input type="radio" class="type-radio" 
                                                            name="ItemTypes[@item.Id]" 
                                                            value="Utilities" id="t3_@item.Id" hidden>
                                                        <label for="t3_@item.Id" class="type-box bg-warning"></label>

                                                        <input type="radio" class="type-radio" 
                                                            name="ItemTypes[@item.Id]" 
                                                            value="Advertising" id="t4_@item.Id" hidden>
                                                        <label for="t4_@item.Id" class="type-box bg-danger"></label>

                                                        <input type="radio" class="type-radio" 
                                                            name="ItemTypes[@item.Id]" 
                                                            value="Artwork" id="t5_@item.Id" hidden>
                                                        <label for="t5_@item.Id" class="type-box bg-info"></label>

                                                        <input type="radio" class="type-radio" 
                                                            name="ItemTypes[@item.Id]" 
                                                            value="Default" id="t6_@item.Id" hidden checked>
                                                        <label for="t6_@item.Id" class="type-box bg-secondary"></label>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                </tbody>
                            </table>
                        </form>
                    </div>
                    <div class="type-legend">
                        <h6 class="mb-3">Transaction Types</h6>

                        <div class="legend-item">
                            <span class="legend-dot bg-success"></span> Ingredients
                        </div>

                        <div class="legend-item">
                            <span class="legend-dot bg-primary"></span> Packaging
                        </div>

                        <div class="legend-item">
                            <span class="legend-dot bg-warning"></span> Utilities
                        </div>

                        <div class="legend-item">
                            <span class="legend-dot bg-danger"></span> Advertising
                        </div>

                        <div class="legend-item">
                            <span class="legend-dot bg-info"></span> Artwork
                        </div>

                        <div class="legend-item">
                            <span class="legend-dot bg-secondary"></span> Default
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>  
</div>



<style>
    .drop-zone {
        border: 3px dashed #dee2e6;
        transition: all 0.3s ease;
    }
    
    .drop-zone.drag-over {
        background-color: #e7f1ff !important;
        border-color: #0d6efd !important;
        box-shadow: 0 0 15px rgba(13, 110, 253, 0.2);
    }
    
    .drop-zone-content {
        pointer-events: none;
    }

    .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }

    .form-check-input:checked:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
    }

    .type-box {
        width: 20px;
        height: 20px;
        cursor: pointer;
        border: 1px solid #212529;
        transition: transform 0.15s ease, border 0.15s ease;

        display: block;
        border-radius: 10px;
    }

    .type-box:hover {
        transform: scale(1.15);
    }

    .type-radio:checked + .type-box {
        border: 2px solid black;
    }

    tbody tr {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .row-ingredients td {
        background-color: #d1e7dd !important;
    }

    .row-packaging td {
        background-color: #cfe2ff !important;
    }

    .row-utilities td {
        background-color: #fff3cd !important;
    }

    .row-advertising td {
    background-color: #f8d7da !important;
    }

    .row-artwork td {
        background-color: #cff4fc !important;
    }

    .amount-col {
        border-right: 4px solid #212529;
    }

    .table.table-striped tbody tr td.type-cell {
        background-color: white !important;
        padding-left: 20px !important;
        padding-right: 20px !important;
    }

    .type-header {
        padding-left: 20px !important;
        padding-right: 20px !important;
    }

    .type-legend {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #dee2e6;
        position: sticky;
        top: 100px;
    }

    /* Each legend row */
    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
        font-size: 0.9rem;
    }

    /* Colored dot */
    .legend-dot {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 1px solid #212529;
    }

</style>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');
    const spinner = document.getElementById('spinner');
    const downloadBtn = document.getElementById('downloadBtn');
    const selectionForm = document.getElementById('selectionForm');
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const selectAll = document.getElementById('selectAll'); 

    function filterSelected() {
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const checkbox = row.querySelector('.item-checkbox');
            if (checkbox && !checkbox.checked) {
                row.style.display = 'none';
            }
        });
    }

    document.querySelectorAll('.type-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            const itemId = this.name.match(/\d+/)[0];
            const row = this.closest('tr');
            row.classList.remove('row-ingredients', 'row-packaging', 'row-utilities', 'row-advertising', 'row-artwork', 'row-default');

            console.log("changed to: " + this.value);
            switch(this.value) {
                case 'Ingredients':
                    row.classList.add('row-ingredients');
                    break;
                case 'Packaging':
                    row.classList.add('row-packaging');
                    break;
                case 'Utilities':
                    row.classList.add('row-utilities');
                    break;
                case 'Advertising':
                    row.classList.add('row-advertising');
                    break;
                case 'Artwork':
                    row.classList.add('row-artwork');
                    break;
                case 'Default':
                    row.classList.add('row-default');
                    break;
            }
        });
    });

</script>
